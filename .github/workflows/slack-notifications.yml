name: Slack Notifications

on:
  # Triggered when deploy-reports workflow completes
  workflow_run:
    workflows: ['Deploy Playwright HTML Report to GitHub Pages']
    types:
      - completed

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      status:
        description: 'Test notification status'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - failure

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Get test and deployment status
        id: status
        run: |
          # Default values for manual trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "deployment_status=${{ github.event.inputs.status }}" >> $GITHUB_OUTPUT
            echo "trigger=manual" >> $GITHUB_OUTPUT
            echo "test_status=skipped" >> $GITHUB_OUTPUT
            echo "workflow_name=Manual Test" >> $GITHUB_OUTPUT
            echo "artifact_issue=false" >> $GITHUB_OUTPUT
          else
            # Get deployment status from deploy-reports workflow
            echo "deployment_status=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
            echo "trigger=auto" >> $GITHUB_OUTPUT
            
            # For workflow_run events, we can access the triggering workflow information
            # The deploy-reports workflow is triggered by completed test workflows
            
            # Extract triggering workflow info from the event context
            TRIGGERING_WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            TRIGGERING_HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
            
            echo "Processing deployment for: $TRIGGERING_WORKFLOW_NAME" >&2
            echo "Head SHA: $TRIGGERING_HEAD_SHA" >&2
            
            # Default values - we know this is triggered by the Deploy workflow which is triggered by test workflows
            TEST_STATUS="unknown"
            WORKFLOW_NAME="Sanity Tests"  # This is our main test workflow
            ARTIFACT_ISSUE="false"
            
            # Since deploy-reports is triggered on test completion, we can infer the test status
            # based on whether the deployment was needed (deploy only runs after successful tests)
            if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
              # If deployment succeeded, the triggering test likely succeeded
              TEST_STATUS="success"
              echo "Deployment succeeded - inferring test success" >&2
            elif [ "${{ github.event.workflow_run.conclusion }}" == "failure" ]; then
              # If deployment failed, we need to check why
              # Since deploy is only triggered after test success, this is likely an artifact/deployment issue
              TEST_STATUS="success"  # Test likely succeeded but deployment had issues
              ARTIFACT_ISSUE="true"
              echo "Deployment failed - likely artifact/deployment issue after successful tests" >&2
            else
              # Other statuses (cancelled, skipped, etc.)
              TEST_STATUS="unknown"
              echo "Deployment status: ${{ github.event.workflow_run.conclusion }}" >&2
            fi
            
            # Additional context from the deploy workflow event
            DEPLOY_CREATED_AT="${{ github.event.workflow_run.created_at }}"
            echo "Deploy workflow created at: $DEPLOY_CREATED_AT" >&2
            
            echo "test_status=${TEST_STATUS}" >> $GITHUB_OUTPUT
            echo "workflow_name=${WORKFLOW_NAME}" >> $GITHUB_OUTPUT
            echo "artifact_issue=${ARTIFACT_ISSUE}" >> $GITHUB_OUTPUT
                     
            # Debug output
            echo "Final values:" >&2
            echo "  deployment_status: ${{ github.event.workflow_run.conclusion }}" >&2
            echo "  test_status: ${TEST_STATUS}" >&2
            echo "  workflow_name: ${WORKFLOW_NAME}" >&2
            echo "  artifact_issue: ${ARTIFACT_ISSUE}" >&2
            echo "  triggering_workflow: $TRIGGERING_WORKFLOW_NAME" >&2
          fi

          # Get current date/time in Israel timezone
          ISRAEL_TIME=$(TZ='Asia/Jerusalem' date '+%d-%m-%Y %H:%M:%S')
          echo "israel_time=$ISRAEL_TIME" >> $GITHUB_OUTPUT

      - name: Notify Slack on Success
        if: steps.status.outputs.deployment_status == 'success'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#testing-updates",
              "text": "âœ… Test Workflow Completed Successfully!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… Test Workflow Completed Successfully!"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸ§ª Test Workflow Status\n\n*Workflow:* ${{ steps.status.outputs.workflow_name }}\n*Status:* ${{ steps.status.outputs.test_status == 'success' && 'âœ… PASSED' || steps.status.outputs.test_status == 'failure' && 'âŒ FAILED' || 'â­ï¸ SKIPPED' }}\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸ“Š Report Deployment Status\n\n*Status:* âœ… DEPLOYED SUCCESSFULLY\n*Report URL:* https://itcb-2.github.io/ITCB-Testing/\n*Deployed at:* ${{ steps.status.outputs.israel_time }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.status.outputs.test_status == 'success' && 'ðŸŽ‰ Great work! All tests passed and reports are now live!' || steps.status.outputs.test_status == 'failure' && 'âš ï¸ Action needed: Some tests failed. Check the detailed report above.' || 'ðŸ“Š Info: Test results are available in the report above.' }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: steps.status.outputs.deployment_status == 'failure'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#testing-updates",
              "text": "âŒ Test Report Deployment Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.artifact_issue == 'true' && 'âš ï¸ Test Report Storage Issue' || 'âŒ Test Report Deployment Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸ§ª Test Workflow Status\n\n*Workflow:* ${{ steps.status.outputs.workflow_name }}\n*Status:* ${{ steps.status.outputs.test_status == 'success' && 'âœ… PASSED' || steps.status.outputs.test_status == 'failure' && 'âŒ FAILED' || 'â­ï¸ SKIPPED' }}\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸ“Š Report Deployment Status\n\n*Status:* âŒ DEPLOYMENT FAILED\n${{ steps.status.outputs.artifact_issue == 'true' && '*Issue:* GitHub artifact storage quota exceeded\n*Note:* Storage quota typically refreshes within 6-12 hours\n*Action:* Reports will auto-deploy once quota is available' || '*Action Required:* Please check the deployment workflow logs' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.status.outputs.artifact_issue == 'true' && 'ðŸ“Š Previous reports still available at:\nðŸ”— https://itcb-2.github.io/ITCB-Testing/' || 'ðŸ”§ Team action needed - Check the workflow logs for deployment issues.\nðŸ”— Previous reports: https://itcb-2.github.io/ITCB-Testing/' }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ðŸ“‹ Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Add notification status to summary
        run: |
          echo "ðŸ“± Slack Notification Sent!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Deployment Status: ${{ steps.status.outputs.deployment_status }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª Test Status: ${{ steps.status.outputs.test_status }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ Workflow: ${{ steps.status.outputs.workflow_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”” Trigger: ${{ steps.status.outputs.trigger }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.status.outputs.artifact_issue }}" == "true" ]; then
            echo "ðŸ“¦ Artifact Issue: GitHub storage quota exceeded" >> $GITHUB_STEP_SUMMARY
            echo "â³ Note: Storage quota typically refreshes within 6-12 hours" >> $GITHUB_STEP_SUMMARY
          fi
          echo "â° Sent at: $(date)" >> $GITHUB_STEP_SUMMARY
